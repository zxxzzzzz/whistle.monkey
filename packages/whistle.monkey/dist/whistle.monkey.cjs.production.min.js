"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(require("koa")),t=e(require("chokidar")),s=e(require("fs")),a=e(require("js-yaml")),o=e(require("path")),r=e(require("micromatch")),i=require("@zhangxin/mock-monkey-core"),c=e(require("findup-sync")),l=e(require("@koa/router")),u=e(require("@koa/cors")),p=e(require("koa-body")),d=e(require("koa-send")),g=require("ws");const f=new Map;function y(e,n){var t;if(!n)throw Error("rule不能为空");if(null==n||null==(t=n.request)||!t.url)throw Error("request的url不能为空");f.set(e,n)}function h(e){f.delete(e)}function b(e){const n=f.get(e);n&&(n.disabled=!0)}function w(e){return f.get(e)}function m(e){return r([...f.keys()],e)}let v;async function k(e){if(v&&await v.close(),!s.existsSync(e))throw Error("path not exist");v=t.watch(e).on("all",(n,t)=>{!async function(e,n){for(const t of e)await t(...n)}([S,O,$],[n,t.replace(/[\\]/g,"/"),e.replace(/[\\]/g,"/")])})}function x(e){let n={request:{url:"",body:{}},response:{body:{}}};try{const t=s.readFileSync(e,{encoding:"utf-8"}),o=a.load(t);if(!o)throw Error("文件内容不能为空");return o.request?o:(n=function(e){const n=e.replace(/\/\/[\s\S]*/g,"");console.log(n,"contentWithoutDocs");const t=JSON.parse(n);return null!=t&&t.request?{}:{request:{url:"",body:{}},response:{body:t}}}(t),s.writeFileSync(e,a.dump({...n}),{encoding:"utf-8"}),n)}catch(t){return console.log(t),s.writeFileSync(e,a.dump(n),{encoding:"utf-8"}),{}}}function q(e,n){const t=c(".ignore",{cwd:e});let a=[];return t&&(a=s.readFileSync(t,{encoding:"utf-8"}).split("\n").filter(e=>!e.startsWith("// ")).map(e=>`${(""+o.parse(t.replace(/[\\]/g,"/")).dir).replace(n,"**")}/${e.replace(/[\s]*/g,"")}`)),a}async function S(e,n){if(".js"===o.parse(n).ext&&["add","change"].includes(e)){const t={add:"添加",change:"更新",unlinkDir:"",unlink:"",addDir:""};try{"change"===e&&delete require.cache[n];const s=require(n);Object.keys(s).forEach(e=>{i.addFunction(e,s[e])}),global.sendLog({message:`${t[e]}了函数<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"success",tags:["添加","函数"]})}catch(s){global.sendLog({message:`${t[e]}函数<span class="text-pink-500">${n}</span>失败，${s.message}`,date:(new Date).valueOf(),type:"success",tags:["添加","函数"]})}}}async function O(e,n,t){const s=o.parse(n);if(".yaml"===s.ext){if("add"===e)try{y(a=n,{...x(a),filePath:a,disabled:!1});const e=q(s.dir,t);if(r.isMatch(n,e))return b(n),void global.sendLog({message:`禁用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"warning",tags:["禁用"]});global.sendLog({message:`添加了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"success",tags:["添加"]})}catch(e){global.sendLog({message:`添加模板<span class="text-pink-500">${n}</span>失败,${e.message}`,date:(new Date).valueOf(),type:"error"})}var a;if("change"===e)try{!function(e){y(e,x(e))}(n),global.sendLog({date:(new Date).valueOf(),message:`更新了模板<span class="text-pink-500">${n}</span>`,type:"success",tags:["更新"]})}catch(e){global.sendLog({message:`更新模板<span class="text-pink-500">${n}</span>失败`,date:(new Date).valueOf(),type:"error"})}"unlinkDir"===e&&m([n+"/*"]).forEach(e=>{h(e),global.sendLog({message:`禁用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"warning",tags:["禁用"]})}),"unlink"===e&&(function(e){h(e)}(n),global.sendLog({date:(new Date).valueOf(),message:`删除了模板<span class="text-pink-500">${n}</span>`,type:"success",tags:["删除"]}))}}async function $(e,n,t){const s=o.parse(n);if(".ignore"===s.name){const e=q(s.dir,t);m(["**"]).forEach(n=>{const t=w(n);if(!0===(null==t?void 0:t.disabled)&&!r.isMatch(n,e))return function(e){const n=f.get(e);n&&(n.disabled=!1)}(n),void global.sendLog({message:`启用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"success",tags:["启用"]});!1===(null==t?void 0:t.disabled)&&r.isMatch(n,e)&&(b(n),global.sendLog({message:`禁用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"warning",tags:["禁用"]}))})}}const j=new n,D=new l;D.post("/cgi-bin/root",async e=>{const n=e.request.body;if(!n.path)return e.response.status=500,void(e.response.message='do not find property "path"');try{const t=JSON.parse(s.readFileSync("./config.json",{encoding:"utf-8"}));t.root=n.path,s.writeFileSync("./config.json",JSON.stringify(t),{encoding:"utf-8"}),await k(n.path),e.response.status=200,e.response.body=JSON.stringify({path:n.path})}catch(n){e.response.status=500,e.response.message=n.message}}),D.get("/cgi-bin/root",async e=>{const{root:n}=JSON.parse(s.readFileSync("./config.json",{encoding:"utf-8"}));e.response.status=200,e.response.body=JSON.stringify({path:n})}),j.proxy=!0,j.silent=!0,j.use(p()).use(u({credentials:!0})).use(D.routes()).use(D.allowedMethods()).use(async e=>{const n=o.resolve(__dirname,"../public"),t=o.parse(e.path);if("/plugin.monkey/"!==e.path){if(""!==t.ext)return s.existsSync(`${n}${e.path}`)?void await d(e,"."+e.path,{root:n}):(e.response.status=500,void(e.response.message="file not found"));await d(e,"./index.html",{root:n})}else await d(e,"./index.html",{root:n})});let L=!1;exports.rulesServer=e=>{const t=new n;t.proxy=!0,t.silent=!0,t.use(e=>{const n=e.request.href,t=function(e){const n=new URL(e).pathname;return[...f.values()].find(e=>n.includes(e.request.url))}(n);if(t){const n=encodeURIComponent(t.filePath);e.body="* monkey://"+n}else e.body=`${n} ${n}`}),e.on("request",t.callback())},exports.server=e=>{e.on("request",(e,n)=>{const t=decodeURIComponent(e.originalReq.ruleValue),s=w(t);if(t){let a="";e.on("data",e=>{a+=e.toString("utf-8")}),e.on("end",()=>{a||(a="{}");try{var o,r;const c=new URL(e.url,"http://"+e.headers.host),l={};c.searchParams.forEach((e,n)=>{l[n]=e});const u={...JSON.parse(a),...l};if(!function e(n,t,s){return!t||n===t||("string"==typeof t?function(e,n,t){const s=i.getValueByStatement(e,t);return"function"==typeof s?s(n):n===s}(t,n,s):"object"==typeof n&&"object"==typeof t&&(Array.isArray(n)&&Array.isArray(t)&&t.every(t=>"object"!=typeof t?n.includes(t):n.some(n=>{e(n,t,s)})),Object.keys(t).every(a=>{const o=n[a];return!!o&&e(o,t[a],s)})))}(u,null==s||null==(o=s.request)?void 0:o.body,u))return void e.passThrough();n.setHeader("Access-Control-Allow-Credentials","true"),n.setHeader("Access-Control-Allow-Origin",e.headers.origin),n.setHeader("Content-Type","application/json");const p=i.generate(null==s||null==(r=s.response)?void 0:r.body,u);n.end(JSON.stringify(p),"utf-8"),global.sendLog({type:"success",message:`请求<span class="text-purple-500">${c.pathname}</span>命中文件<span class="text-pink-500">${t}</span>`,date:(new Date).valueOf(),tags:["命中"]})}catch(e){n.setHeader("Content-Type","text/plain"),n.end(e.message,"utf-8"),console.log(e)}})}})},exports.uiServer=e=>{s.existsSync("./config.json")||s.writeFileSync("./config.json",JSON.stringify({root:""}),{encoding:"utf-8"}),e.on("request",j.callback()),new g.Server({port:9999}).on("connection",(function(e){if(global.sendLog=n=>{e.send(JSON.stringify(n))},!L){const{root:e}=JSON.parse(s.readFileSync("./config.json",{encoding:"utf-8"}));e&&(k(e),L=!0)}}))};
//# sourceMappingURL=whistle.monkey.cjs.production.min.js.map
