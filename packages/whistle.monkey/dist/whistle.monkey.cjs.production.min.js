"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(require("koa")),s=e(require("chokidar")),t=e(require("fs")),a=e(require("yaml")),o=e(require("path")),r=e(require("micromatch")),i=require("@zhangxin/mock-monkey-core"),c=e(require("findup-sync")),l=e(require("@koa/router")),u=e(require("@koa/cors")),p=e(require("koa-body")),d=e(require("koa-send")),g=require("ws");const f=new Map;function y(e,n){if(!n)throw Error("rule不能为空");f.set(e,n)}function h(e){f.delete(e)}function m(e){const n=f.get(e);n&&(n.disabled=!0)}function b(e){return f.get(e)}function w(e){return r([...f.keys()],e)}let v;async function k(e){if(v&&await v.close(),!t.existsSync(e))throw Error("path not exist");v=s.watch(e).on("all",(n,s)=>{!async function(e,n){for(const s of e)await s(...n)}([S,q,$],[n,s.replace(/[\\]/g,"/"),e.replace(/[\\]/g,"/")])})}function x(e){try{const n=t.readFileSync(e,{encoding:"utf-8"});return a.parse(n)}catch(e){return{}}}function O(e,n){const s=c(".ignore",{cwd:e});let a=[];return s&&(a=t.readFileSync(s,{encoding:"utf-8"}).split("\n").filter(e=>!e.startsWith("// ")).map(e=>`${(""+o.parse(s.replace(/[\\]/g,"/")).dir).replace(n,"**")}/${e.replace(/[\s]*/g,"")}`)),a}async function S(e,n){if(".js"===o.parse(n).ext&&["add","change"].includes(e)){const s={add:"添加",change:"更新",unlinkDir:"",unlink:"",addDir:""};try{"change"===e&&delete require.cache[n];const t=require(n);Object.keys(t).forEach(e=>{i.addFunction(e,t[e])}),global.sendLog({message:`${s[e]}了函数<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"success",tags:["添加","函数"]})}catch(t){global.sendLog({message:`${s[e]}函数<span class="text-pink-500">${n}</span>失败，${t.message}`,date:(new Date).valueOf(),type:"success",tags:["添加","函数"]})}}}async function q(e,n,s){const t=o.parse(n);if(".yaml"===t.ext){if("add"===e)try{y(a=n,{...x(a),filePath:a,disabled:!1});const e=O(t.dir,s);if(r.isMatch(n,e))return m(n),void global.sendLog({message:`禁用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"warning",tags:["禁用"]});global.sendLog({message:`添加了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"success",tags:["添加"]})}catch(e){global.sendLog({message:`添加模板<span class="text-pink-500">${n}</span>失败,${e.message}`,date:(new Date).valueOf(),type:"error"})}var a;if("change"===e)try{!function(e){y(e,x(e))}(n),global.sendLog({date:(new Date).valueOf(),message:`更新了模板<span class="text-pink-500">${n}</span>`,type:"success",tags:["更新"]})}catch(e){global.sendLog({message:`更新模板<span class="text-pink-500">${n}</span>失败`,date:(new Date).valueOf(),type:"error"})}"unlinkDir"===e&&w([n+"/*"]).forEach(e=>{h(e),global.sendLog({message:`禁用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"warning",tags:["禁用"]})}),"unlink"===e&&(function(e){h(e)}(n),global.sendLog({date:(new Date).valueOf(),message:`删除了模板<span class="text-pink-500">${n}</span>`,type:"success",tags:["删除"]}))}}async function $(e,n,s){const t=o.parse(n);if(".ignore"===t.name){const e=O(t.dir,s);w(["**"]).forEach(n=>{const s=b(n);if(!0===(null==s?void 0:s.disabled)&&!r.isMatch(n,e))return function(e){const n=f.get(e);n&&(n.disabled=!1)}(n),void global.sendLog({message:`启用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"success",tags:["启用"]});!1===(null==s?void 0:s.disabled)&&r.isMatch(n,e)&&(m(n),global.sendLog({message:`禁用了模板<span class="text-pink-500">${n}</span>`,date:(new Date).valueOf(),type:"warning",tags:["禁用"]}))})}}const j=new n,D=new l;D.post("/cgi-bin/root",async e=>{const n=e.request.body;if(!n.path)return e.response.status=500,void(e.response.message='do not find property "path"');try{const s=JSON.parse(t.readFileSync("./config.json",{encoding:"utf-8"}));s.root=n.path,t.writeFileSync("./config.json",JSON.stringify(s),{encoding:"utf-8"}),await k(n.path),e.response.status=200,e.response.body=JSON.stringify({path:n.path})}catch(n){e.response.status=500,e.response.message=n.message}}),D.get("/cgi-bin/root",async e=>{const{root:n}=JSON.parse(t.readFileSync("./config.json",{encoding:"utf-8"}));e.response.status=200,e.response.body=JSON.stringify({path:n})}),j.proxy=!0,j.silent=!0,j.use(p()).use(u({credentials:!0})).use(D.routes()).use(D.allowedMethods()).use(async e=>{const n=o.resolve(__dirname,"../public"),s=o.parse(e.path);if("/plugin.monkey/"!==e.path){if(""!==s.ext)return t.existsSync(`${n}${e.path}`)?void await d(e,"."+e.path,{root:n}):(e.response.status=500,void(e.response.message="file not found"));await d(e,"./index.html",{root:n})}else await d(e,"./index.html",{root:n})});let L=!1;exports.rulesServer=e=>{const s=new n;s.proxy=!0,s.silent=!0,s.use(e=>{const n=e.request.href,s=function(e){const n=new URL(e).pathname;return[...f.values()].find(e=>n.includes(e.request.url))}(n);if(s){const n=encodeURIComponent(s.filePath);e.body="* monkey://"+n}else e.body=`${n} ${n}`}),e.on("request",s.callback())},exports.server=e=>{e.on("request",(e,n)=>{const s=decodeURIComponent(e.originalReq.ruleValue),t=b(s);if(s){let a="";e.on("data",e=>{a+=e.toString("utf-8")}),e.on("end",()=>{a||(a="{}");try{var o,r;const c=new URL(e.url,"http://"+e.headers.host),l={};c.searchParams.forEach((e,n)=>{l[n]=e});const u={...JSON.parse(a),...l};if(!function e(n,s,t){return!s||n===s||("string"==typeof s?function(e,n,s){const t=i.getValueByStatement(e,s);return"function"==typeof t?t(n):n===t}(s,n,t):"object"==typeof n&&"object"==typeof s&&(Array.isArray(n)&&Array.isArray(s)&&s.every(s=>"object"!=typeof s?n.includes(s):n.some(n=>{e(n,s,t)})),Object.keys(s).every(a=>{const o=n[a];return!!o&&e(o,s[a],t)})))}(u,null==t||null==(o=t.request)?void 0:o.body,u))return void e.passThrough();n.setHeader("Access-Control-Allow-Credentials","true"),n.setHeader("Access-Control-Allow-Origin",e.headers.origin),n.setHeader("Content-Type","application/json");const p=i.generate(null==t||null==(r=t.response)?void 0:r.body,u);n.end(JSON.stringify(p),"utf-8"),global.sendLog({type:"success",message:`请求<span class="text-purple-500">${c.pathname}</span>命中文件<span class="text-pink-500">${s}</span>`,date:(new Date).valueOf(),tags:["命中"]})}catch(e){n.setHeader("Content-Type","text/plain"),n.end(e.message,"utf-8"),console.log(e)}})}})},exports.uiServer=e=>{t.existsSync("./config.json")||t.writeFileSync("./config.json",JSON.stringify({root:""}),{encoding:"utf-8"}),e.on("request",j.callback()),new g.Server({port:9999}).on("connection",(function(e){if(global.sendLog=n=>{e.send(JSON.stringify(n))},!L){const{root:e}=JSON.parse(t.readFileSync("./config.json",{encoding:"utf-8"}));e&&(k(e),L=!0)}}))};
//# sourceMappingURL=whistle.monkey.cjs.production.min.js.map
